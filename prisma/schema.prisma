generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  profile   Profile?

  @@map("users")
}

model Profile {
  id                    String        @id
  email                 String        @unique
  fullName              String?       @map("full_name")
  role                  Role          @default(dreamer)
  avatarUrl             String?       @map("avatar_url")
  bio                   String?
  isAvailable           Boolean       @default(true) @map("is_available")
  totalInterpretations  Int           @default(0) @map("total_interpretations")
  rating                Decimal       @default(0.00) @db.Decimal(3, 2)
  currentPlanId         String?       @map("current_plan_id")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")
  adminLogs             AdminLog[]
  chatMessages          ChatMessage[]
  comments              Comment[]
  dreamsAsDreamer       Dream[]       @relation("DreamerDreams")
  dreamsAsInterpreter   Dream[]       @relation("InterpreterDreams")
  messages              Message[]
  payments              Payment[]
  currentPlan           Plan?         @relation("CurrentPlan", fields: [currentPlanId], references: [id])
  user                  User          @relation(fields: [id], references: [id], onDelete: Cascade)
  requestsAsDreamer     Request[]     @relation("DreamerRequests")
  requestsAsInterpreter Request[]     @relation("InterpreterRequests")
  userPlans             UserPlan[]

  @@index([currentPlanId], map: "profiles_current_plan_id_fkey")
  @@map("profiles")
}

model Dream {
  id             String      @id @default(uuid())
  dreamerId      String      @map("dreamer_id")
  interpreterId  String?     @map("interpreter_id")
  title          String
  content        String
  status         DreamStatus @default(new)
  interpretation String?
  description    String?     @db.Text // Changed from 'notes' and type updated
  dreamDate      DateTime?   @map("dream_date")
  mood           String?
  metadata       Json?
  audioUrl       String?     @map("audio_url") @db.VarChar(500)
  audioDuration  Int?        @map("audio_duration") // in seconds
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  dreamer     Profile   @relation("DreamerDreams", fields: [dreamerId], references: [id], onDelete: Cascade)
  interpreter Profile?  @relation("InterpreterDreams", fields: [interpreterId], references: [id], onDelete: SetNull)
  messages    Message[]
  comments    Comment[]
  requests    Request[]

  @@index([dreamerId])
  @@index([interpreterId])
  @@index([status])
  @@map("dreams")
}

model Message {
  id          String      @id @default(uuid())
  dreamId     String      @map("dream_id")
  senderId    String      @map("sender_id")
  content     String
  messageType MessageType @default(text) @map("message_type")
  audioUrl    String?     @map("audio_url") @db.VarChar(500)
  createdAt   DateTime    @default(now()) @map("created_at")

  // Relations
  dream  Dream   @relation(fields: [dreamId], references: [id], onDelete: Cascade)
  sender Profile @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([dreamId])
  @@index([senderId])
  @@map("messages")
}

enum MessageType {
  text
  interpretation
  inquiry
  audio
}

model Comment {
  id        String   @id @default(uuid())
  dreamId   String   @map("dream_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  dream     Dream    @relation(fields: [dreamId], references: [id], onDelete: Cascade)
  user      Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([dreamId])
  @@index([userId], map: "comments_user_id_fkey")
  @@map("comments")
}

model ChatMessage {
  id          String          @id @default(uuid())
  requestId   String          @map("request_id")
  senderId    String          @map("sender_id")
  content     String
  messageType ChatMessageType @default(text) @map("message_type")
  fileUrl     String?         @map("file_url")
  isRead      Boolean         @default(false) @map("is_read")
  createdAt   DateTime        @default(now()) @map("created_at")
  request     Request         @relation(fields: [requestId], references: [id], onDelete: Cascade)
  sender      Profile         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([requestId], map: "chat_messages_request_id_fkey")
  @@index([senderId], map: "chat_messages_sender_id_fkey")
  @@map("chat_messages")
}

model Plan {
  id                 String     @id @default(uuid())
  name               String     @unique
  description        String?
  price              Decimal    @db.Decimal(10, 2)
  currency           String     @map("currency") @db.VarChar(3)
  scope              PlanScope  @default(international)
  countryCodes       Json?      @map("country_codes")
  durationDays       Int        @map("duration_days")
  maxDreams          Int?       @map("max_dreams")
  maxInterpretations Int?       @map("max_interpretations")
  letterQuota        Int?       @map("letter_quota")
  audioMinutesQuota  Int?       @map("audio_minutes_quota")
  features           Json
  isActive           Boolean    @default(true) @map("is_active")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")
  isTrial            Boolean    @default(false) @map("is_trial")
  trialDurationDays  Int?       @map("trial_duration_days")
  payments           Payment[]
  profilesUsingPlan  Profile[]  @relation("CurrentPlan")
  userPlans          UserPlan[]

  @@map("plans")
}

model UserPlan {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  planId           String    @map("plan_id")
  startedAt        DateTime  @default(now()) @map("started_at")
  expiresAt        DateTime? @map("expires_at")
  isActive         Boolean   @default(true) @map("is_active")
  lettersUsed      Int       @default(0) @map("letters_used")
  audioMinutesUsed Int       @default(0) @map("audio_minutes_used")
  createdAt        DateTime  @default(now()) @map("created_at")
  plan             Plan      @relation(fields: [planId], references: [id], onDelete: Cascade)
  user             Profile   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, planId])
  @@index([planId], map: "user_plans_plan_id_fkey")
  @@map("user_plans")
}

model Payment {
  id        String        @id @default(uuid())
  userId    String        @map("user_id")
  planId    String?       @map("plan_id")
  amount    Decimal       @db.Decimal(10, 2)
  currency  String        @db.VarChar(3)
  status    PaymentStatus @default(pending)
  provider  String?       @map("provider") @db.VarChar(100)
  reference String?       @map("reference")
  metadata  Json?
  paidAt    DateTime?     @map("paid_at")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  plan      Plan?         @relation(fields: [planId], references: [id])
  user      Profile       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([planId], map: "payments_plan_id_fkey")
  @@index([userId], map: "payments_user_id_fkey")
  @@map("payments")
}

model Request {
  id            String        @id @default(uuid())
  dreamId       String        @map("dream_id")
  dreamerId     String        @map("dreamer_id")
  interpreterId String?       @map("interpreter_id")
  status        RequestStatus @default(open)
  title         String
  description   String?
  budget        Decimal?      @db.Decimal(10, 2)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  completedAt   DateTime?     @map("completed_at")
  chatMessages  ChatMessage[]
  dream         Dream         @relation(fields: [dreamId], references: [id], onDelete: Cascade)
  dreamer       Profile       @relation("DreamerRequests", fields: [dreamerId], references: [id], onDelete: Cascade)
  interpreter   Profile?      @relation("InterpreterRequests", fields: [interpreterId], references: [id])

  @@index([dreamId], map: "requests_dream_id_fkey")
  @@index([dreamerId], map: "requests_dreamer_id_fkey")
  @@index([interpreterId], map: "requests_interpreter_id_fkey")
  @@map("requests")
}

model AdminLog {
  id         String   @id @default(uuid())
  adminId    String   @map("admin_id")
  action     String
  targetType String?  @map("target_type")
  targetId   String?  @map("target_id")
  details    Json?
  createdAt  DateTime @default(now()) @map("created_at")
  admin      Profile  @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId], map: "admin_logs_admin_id_fkey")
  @@map("admin_logs")
}

model PageContent {
  id          String   @id @default(uuid())
  pageKey     String   @unique @map("page_key") @db.VarChar(100)
  title       String?  @db.VarChar(255)
  content     String   @db.Text
  metadata    Json?
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("page_contents")
}

enum Role {
  dreamer
  interpreter
  admin
  super_admin
}

enum DreamStatus {
  new
  pending_inquiry
  pending_interpretation
  interpreted
  returned
}

enum ChatMessageType {
  text
  interpretation
  inquiry
  file
}

enum PlanScope {
  egypt
  international
  custom
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
  cancelled
}

enum RequestStatus {
  open
  assigned
  in_progress
  completed
  cancelled
  pending
  accepted
  rejected
}

enum messages_message_type {
  text
  interpretation
  inquiry
}
